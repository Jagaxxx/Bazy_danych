---
title: "Raport"
format: html
editor: visual
---

# Raport

Niniejszy raport został wykonany na zlecenie firmy „Space-U”, organizującej konsumenckie załogowe loty kosmiczne, a w szczególności wycieczki z jasną i ciemną stroną mocy w świecie Star Wars. Celem raportu jest analiza danych zebranych przez firmę podczas 2 lat obecności na rynku, która pozwoli na wyciągnięcie wniosków na temat dotychczasowej działalności: związanych z nią kosztów oraz zysków, a także stosunku klientów do proponowanej oferty. Dzięki temu, możliwe będzie wskazanie kierunku rozwoju dla firmy w najbliższej przyszłości.

Podczas analizy posłużymy się następującymi pytaniami badawczymi:

-   Które z proponowanych przez firmę rodzajów wycieczek cieszą się największą popularnością? Jak kształtuje się ich bilans zysków i strat? Czy są dla firmy opłacalne?
-   Czy na podstawie wykresu liczby obsłużonych klientów w każdym miesiącu działalności firmy możemy wyciągnąć wnioski, że firma się rozwija lub podupada?
-   Po których z proponowanych wycieczek klienci są skłonni wybrać się na kolejne, a po których nie wracają do firmy? Czy można na tej podstawie wycofać niektóre wycieczki z oferty?
-   Który z typów wycieczek cieszy się większą popularnością – wycieczki z jasną czy ciemną stroną mocy?
-   Jak często podczas wyjazdów zdarzają się wypadki konkretnych typów i jaka część klientów jest ubezpieczona na wypadek ich wystąpienia?
-   Czy wycieczki, którym klienci wystawiają najwyższe oceny, są również najchętniej wybierane?
-   Którzy spośród naszych pracowników (pilot i przewodnik) najczęściej latali wspólnie na wycieczki?

## Analiza

```{r}
#| echo: false
#| warning: false
library(RMariaDB)
library(ggplot2)
library(dplyr)
library(tidyr)

#połączenie z bazą danych
con <- dbConnect(RMariaDB::MariaDB(),
                 dbname = "team12",
                 username = "team12",
                 password = "te@mliz",
                 host = "giniewicz.it")
```

### Które z proponowanych przez firmę rodzajów wycieczek cieszą się największą popularnością? Jak kształtuje się ich bilans zysków i strat? Czy są dla firmy opłacalne?

```{r}

```

### Czy na podstawie wykresu liczby obsłużonych klientów w każdym miesiącu działalności firmy możemy wyciągnąć wnioski, że firma się rozwija lub podupada?

```{r}
#| echo: false
#| warning: false

query_2g_2 <- "SELECT COUNT(p.id_customer) AS liczba_klientow,
                 DATE_FORMAT(spf.departure_date, '%Y') AS rok
FROM spaceflight AS spf
INNER JOIN payment AS p ON spf.id_spaceflight = p.id_spaceflight
GROUP BY rok
ORDER BY rok;"

df <- dbGetQuery(con, query_2g_2)

ggplot(df, aes(x = rok, y = liczba_klientow)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba klientów - zestawienie lat",
       x = "Rok",
       y = "Liczba klientów") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

max_idx <- which.max(df$liczba_klientow)
min_idx <- which.min(df$liczba_klientow)

best_year <- as.character(df$rok[max_idx]) 
worse_year <- as.character(df$rok[min_idx])

b_number_of_clients <- df$liczba_klientow[max_idx]
w_number_of_clients <- df$liczba_klientow[min_idx]
difference <- abs(b_number_of_clients - w_number_of_clients)

# Tworzenie informacji tekstowej
if (best_year > worse_year) {
  str <- paste("możemy stwierdzić, że z roku na rok w naszej firmie przybywa coraz więcej klientów. W roku", 
               best_year, "było", b_number_of_clients,"klientów. To o", 
               difference,"klientów więcejniż w roku", 
               worse_year,".")
} else if (best_year < worse_year) {
  str <- paste("możemy stwierdzić, że z roku na rok w naszej firmie ubywa klientów. W roku", 
               worse_year,"było", w_number_of_clients,"klientów. To o", 
               difference,"klientów mniej niż w roku", 
               best_year,".")
} else {
  str <- "możemy stwierdzić, że liczba klientów się nie zmieniła na przestrzeni lat."
}
```

Porównując dane na tle lat `r str`

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 7

query_2g <- "SELECT COUNT(p.id_customer) AS liczba_klientow,
                 DATE_FORMAT(spf.departure_date, '%Y-%m') AS data
FROM spaceflight AS spf
INNER JOIN payment AS p ON spf.id_spaceflight = p.id_spaceflight
GROUP BY data
ORDER BY data;"

df <- dbGetQuery(con, query_2g)

df$rok <- as.numeric(substr(df$data, 1, 4))

df$miesiac <- as.numeric(substr(df$data, 6, 7))

ggplot(df, aes(x = data, y = liczba_klientow, fill = as.factor(rok))) + 
  geom_col() + 
  labs(title = "Liczba klientów według miesiąca",
       x = "Rok-miesiąc",
       y = "Liczba klientów",
       fill = "Rok") + 
  scale_fill_manual(values = c("2098" = "red", "2099" = "blue")) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

df_max_miesiac <- df %>%
  group_by(rok) %>%
  slice_max(liczba_klientow, n = 1, with_ties = FALSE)

months <- c("styczeń", "luty", "marzec", "kwiecień", "maj", "czerwiec", "lipiec", "sierpień", "wrzesień", "październik", "listopad", "grudzień")

best_month_best_year <- df_max_miesiac[df_max_miesiac[, "rok"] == best_year, "miesiac"]
best_month_worse_year <- df_max_miesiac[df_max_miesiac[, "rok"] == worse_year, "miesiac"]


```



### Po których z proponowanych wycieczek klienci są skłonni wybrać się na kolejne, a po których nie wracają do firmy? Czy można na tej podstawie wycofać niektóre wycieczki z oferty?

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 14

query3_1 <- "WITH more_than_one_trip AS (SELECT payment.id_customer AS id_customer, spaceflight.id_trip AS id_trip, trip_type.trip_name AS trip_name
FROM payment INNER JOIN spaceflight ON payment.id_spaceflight = spaceflight.id_spaceflight INNER JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip
WHERE id_customer IN (
    SELECT id_customer FROM payment
    GROUP BY id_customer
    HAVING COUNT(id_spaceflight) > 1))


SELECT trip_name AS nazwa_wycieczki, COUNT(*) AS liczba_klientów
FROM (SELECT *, ROW_NUMBER() OVER (PARTITION BY id_customer) AS rn
    FROM more_than_one_trip) AS subquery
WHERE rn = 1
GROUP BY trip_name ORDER BY COUNT(*) DESC"

df3_1 <- dbGetQuery(con, query3_1)

ggplot(df3_1, aes(x = df3_1$nazwa_wycieczki, y = df3_1$liczba_klientów)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba klientów, którzy wrócili do firmy po danej wycieczce", x = "Nazwa wycieczki", y = "Liczba klientów") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 14

query3_2 <- "WITH one_trip AS (SELECT payment.id_customer AS id_customer, spaceflight.id_trip AS id_trip, trip_type.trip_name AS trip_name
FROM payment INNER JOIN spaceflight ON payment.id_spaceflight = spaceflight.id_spaceflight INNER JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip
WHERE id_customer IN (
    SELECT id_customer FROM payment
    GROUP BY id_customer
    HAVING COUNT(id_spaceflight) = 1))

SELECT trip_name AS nazwa_wycieczki, COUNT(*) AS liczba_klientów
FROM one_trip
GROUP BY trip_name ORDER BY COUNT(*) DESC"

df3_2 <- dbGetQuery(con, query3_2)

ggplot(df3_2, aes(x = df3_2$nazwa_wycieczki, y = df3_2$liczba_klientów)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba klientów, którzy nie wrócili do firmy po danej wycieczce", x = "Nazwa wycieczki", y = "Liczba klientów") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Który z typów wycieczek cieszy się większą popularnością – wycieczki z jasną czy ciemną stroną mocy?

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 14

query4 <- "SELECT force_side AS strona_mocy, COUNT(*) AS liczba_klientów
FROM spaceflight INNER JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip
INNER JOIN payment ON spaceflight.id_spaceflight = payment.id_spaceflight
GROUP BY force_side ORDER BY COUNT(*) DESC"

df4 <- dbGetQuery(con, query4)

ggplot(df4, aes(x = df4$strona_mocy, y = df4$liczba_klientów)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba klientów w zależności od strony mocy", x = "Strona mocy", y = "Liczba klientów")
```

### Jak często podczas wyjazdów zdarzają się wypadki konkretnych typów i jaka część klientów jest ubezpieczona na wypadek ich wystąpienia?

```{r}
#| echo: false
#| warning: false

query_2 <- "SELECT COUNT(ar.id_accident) AS liczba_wypadkow, at.accident_type AS rodzaj_wypadku
FROM accident_report AS ar
INNER JOIN accident_type AS at ON ar.id_accident = at.id_accident
GROUP BY ar.id_accident;"

df <- dbGetQuery(con, query_2)

ggplot(df, aes(x = rodzaj_wypadku, y = liczba_wypadkow)) + 
  geom_col(fill="lightblue") + 
  labs(title = "Liczba wypadków podczas podróży",
       x = "Rodzaj wypadku",
       y = "Liczba wypadków") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

max_incident_idx <- which.max(df$liczba_wypadkow)
df[max_incident_idx, "rodzaj_wypadku"]
```

```{r}
#| echo: false
#| warning: false

query_2_2 <- "SELECT
    ar.id_report,
    at.accident_type,
    i.type,
    IF(ic.id_accident IS NOT NULL, 1, 0) AS czy_pokrywa
FROM
    accident_report AS ar
        LEFT JOIN
    payment AS p ON p.id_payment = ar.id_payment
        LEFT JOIN
    insurance_coverage AS ic ON ic.id_insurance = p.id_insurance
        AND ic.id_accident = ar.id_accident
        LEFT JOIN
    insurance AS i ON p.id_insurance = i.id_insurance
        LEFT JOIN
    accident_type AS at ON ar.id_accident = at.id_accident

ORDER BY
    ar.id_report;"

df <- dbGetQuery(con, query_2_2)

df$czy_pokrywa <- ifelse(df$czy_pokrywa == 1, "Tak", "Nie")
df$czy_pokrywa <- factor(df$czy_pokrywa, levels = c("Nie", "Tak"))


ggplot(df, aes(x = accident_type, fill = czy_pokrywa)) + 
  geom_bar() + 
  labs(title = "Liczba wypadków według rodzaju", 
       x = "Rodzaj wypadku", 
       y = "Liczba wypadków", 
       fill = "Czy ubezpieczenie \npokrywa wypadek") + 
  scale_fill_manual(values = c("Nie" = "lightpink", "Tak" = "lightblue")) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

tak_df <- df %>%
  filter(czy_pokrywa == "Tak") %>%
  count(accident_type, name = "tak")

nie_df <- df %>%
  filter(czy_pokrywa == "Nie") %>%
  count(accident_type, name = "nie")

wynik <- full_join(tak_df, nie_df, by = "accident_type") %>%
  mutate(
    tak = replace_na(tak, 0),
    nie = replace_na(nie, 0),
    ratio = tak / (tak + nie)
  )

wynik
```

### Czy wycieczki, którym klienci wystawiają najwyższe oceny, są również najchętniej wybierane?

```{r}

```

### Którzy spośród naszych pracowników (pilot i przewodnik) najczęściej latali wspólnie na wycieczki?

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 14

query7 <- "SELECT s.id_pilot AS id_pilota, s.id_guide AS id_przewodnika, CONCAT(e1.first_name, ' ', e1.last_name, ', ', e2.first_name, ' ', 
e2.last_name) AS imiona, COUNT(*) AS liczba_wyjazdów
FROM spaceflight AS s INNER JOIN employee AS e1 ON s.id_pilot = e1.id_employee
INNER JOIN employee AS e2 ON s.id_guide = e2.id_employee
GROUP BY s.id_pilot, s.id_guide
ORDER BY COUNT(*) DESC"

df7 <- dbGetQuery(con, query7)

ggplot(df7, aes(x = df7$imiona, y = df7$liczba_wyjazdów)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba wspólnych wyjazdów wybranych członków załogi", x = "Załoga", y = "Liczba wyjazdów") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
#| echo: false
#zamykanie połączenia
dbDisconnect(con)
```
