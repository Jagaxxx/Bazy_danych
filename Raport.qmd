---
title: "Raport"
format: html
editor: visual
execute:
  eval: true
---

# Raport

Niniejszy raport został wykonany na zlecenie firmy „Space-U”, organizującej konsumenckie załogowe loty kosmiczne, a w szczególności wycieczki z jasną i ciemną stroną mocy w świecie Star Wars. Celem raportu jest analiza danych zebranych przez firmę podczas 2 lat obecności na rynku, która pozwoli na wyciągnięcie wniosków na temat dotychczasowej działalności: związanych z nią kosztów oraz zysków, a także stosunku klientów do proponowanej oferty. Dzięki temu, możliwe będzie wskazanie kierunku rozwoju dla firmy w najbliższej przyszłości.

Podczas analizy posłużymy się następującymi pytaniami badawczymi:

-   Które z proponowanych przez firmę rodzajów wycieczek cieszą się największą popularnością? Jak kształtuje się ich bilans zysków i strat? Czy są dla firmy opłacalne?
-   Czy na podstawie wykresu liczby obsłużonych klientów w każdym miesiącu działalności firmy możemy wyciągnąć wnioski, że firma się rozwija lub podupada?
-   Po których z proponowanych wycieczek klienci są skłonni wybrać się na kolejne, a po których nie wracają do firmy? Czy można na tej podstawie wycofać niektóre wycieczki z oferty?
-   Który z typów wycieczek cieszy się większą popularnością – wycieczki z jasną czy ciemną stroną mocy?
-   Jak często podczas wyjazdów zdarzają się wypadki konkretnych typów i jaka część klientów jest ubezpieczona na wypadek ich wystąpienia?
-   Czy wycieczki, którym klienci wystawiają najwyższe oceny, są również najchętniej wybierane?
-   Którzy spośród naszych pracowników (pilot i przewodnik) najczęściej latali wspólnie na wycieczki?

## Analiza

```{r}
#| echo: false
#| warning: false
library(RMariaDB)
library(ggplot2)

#połączenie z bazą danych
con <- dbConnect(RMariaDB::MariaDB(),
                 dbname = "team12",
                 username = "team12",
                 password = "te@mliz",
                 host = "giniewicz.it")
```

### Które z proponowanych przez firmę rodzajów wycieczek cieszą się największą popularnością? Jak kształtuje się ich bilans zysków i strat? Czy są dla firmy opłacalne?

```{r}

```

### Czy na podstawie wykresu liczby obsłużonych klientów w każdym miesiącu działalności firmy możemy wyciągnąć wnioski, że firma się rozwija lub podupada?

```{r}

```

### Po których z proponowanych wycieczek klienci są skłonni wybrać się na kolejne, a po których nie wracają do firmy? Czy można na tej podstawie wycofać niektóre wycieczki z oferty?

Kolejne zagadnienie dotyczy badania chęci wybierania się klientów na kolejne wycieczki z firmą. W tym celu klienci zostali podzieleni na 2 grupy: tych, którzy w ciągu 2 lat działalności „Space-U” wybrali się tylko na jeden wyjazd, oraz tych, którzy odwiedzili kilka miejsc. Dla każdej z grup zliczono wycieczki, które wybrano podczas pierwszych wylotów – pierwsze wrażenia zdecydowały o tym, czy klienci ponownie obdarzyli firmę zaufaniem, czy też nie.

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 12

query3_1 <- "WITH more_than_one_trip AS (SELECT payment.id_customer AS id_customer, spaceflight.id_trip AS id_trip, trip_type.trip_name AS trip_name
FROM payment INNER JOIN spaceflight ON payment.id_spaceflight = spaceflight.id_spaceflight INNER JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip
WHERE id_customer IN (
    SELECT id_customer FROM payment
    GROUP BY id_customer
    HAVING COUNT(id_spaceflight) > 1))


SELECT trip_name AS nazwa_wycieczki, COUNT(*) AS liczba_klientów
FROM (SELECT *, ROW_NUMBER() OVER (PARTITION BY id_customer) AS rn
    FROM more_than_one_trip) AS subquery
WHERE rn = 1
GROUP BY trip_name ORDER BY COUNT(*) DESC LIMIT 3"

df3_1 <- dbGetQuery(con, query3_1)

query3_1_1 <- "WITH more_than_one_trip AS (SELECT payment.id_customer AS id_customer, spaceflight.id_trip AS id_trip, trip_type.trip_name AS trip_name
FROM payment INNER JOIN spaceflight ON payment.id_spaceflight = spaceflight.id_spaceflight INNER JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip
WHERE id_customer IN (
    SELECT id_customer FROM payment
    GROUP BY id_customer
    HAVING COUNT(id_spaceflight) > 1))

SELECT trip_name AS nazwa_najczesciej_powtarzanej_wycieczki, COUNT(*) AS liczba_klientów
FROM (SELECT *, ROW_NUMBER() OVER (PARTITION BY id_customer) AS rn
    FROM more_than_one_trip) AS subquery
WHERE rn = 1
GROUP BY trip_name ORDER BY COUNT(*) DESC LIMIT 1"

df3_1_1 <- dbGetQuery(con, query3_1_1)

most_repeated_trip <- df3_1_1$nazwa_najczesciej_powtarzanej_wycieczki


ggplot(df3_1, aes(x = df3_1$nazwa_wycieczki, y = df3_1$liczba_klientów)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba klientów, którzy wrócili do firmy po danej wycieczce", x = "Nazwa wycieczki", y = "Liczba klientów") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Klienci, którzy zdecydowali się wziąć udział w więcej niż jednym wyjeździe, najczęściej wykupowali za pierwszym razem następujące wycieczki: `r df3_1$nazwa_wycieczki[1]`, `r df3_1$nazwa_wycieczki[2]`, `r df3_1$nazwa_wycieczki[3]`. Najpopularniejszą wycieczką wśród nich była wycieczka o nazwie `r most_repeated_trip`, na którą wybrało się `r df3_1_1$liczba_klientów` klientów. Może to oznaczać, że zwiedzającym spodobał się klimat wycieczki, a w planie firmy na najbliższy czas należy uwzględnić organizację większej liczby wycieczek tego typu bądź wprowadzić do oferty więcej rodzajów wyjazdów w podobnym klimacie.

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 12

query3_2 <- "WITH one_trip AS (SELECT payment.id_customer AS id_customer, spaceflight.id_trip AS id_trip, trip_type.trip_name AS trip_name
FROM payment INNER JOIN spaceflight ON payment.id_spaceflight = spaceflight.id_spaceflight INNER JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip
WHERE id_customer IN (
    SELECT id_customer FROM payment
    GROUP BY id_customer
    HAVING COUNT(id_spaceflight) = 1))

SELECT trip_name AS nazwa_wycieczki, COUNT(*) AS liczba_klientów
FROM one_trip
GROUP BY trip_name ORDER BY COUNT(*) DESC LIMIT 3"

df3_2 <- dbGetQuery(con, query3_2)

query3_2_1 <- "WITH one_trip AS (SELECT payment.id_customer AS id_customer, spaceflight.id_trip AS id_trip, trip_type.trip_name AS trip_name
FROM payment INNER JOIN spaceflight ON payment.id_spaceflight = spaceflight.id_spaceflight INNER JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip
WHERE id_customer IN (
    SELECT id_customer FROM payment
    GROUP BY id_customer
    HAVING COUNT(id_spaceflight) = 1))

SELECT trip_name AS nazwa_wycieczki, COUNT(*) AS liczba_klientów
FROM one_trip
GROUP BY trip_name ORDER BY COUNT(*) DESC LIMIT 1"

df3_2_1 <- dbGetQuery(con, query3_2_1)

ggplot(df3_2, aes(x = df3_2$nazwa_wycieczki, y = df3_2$liczba_klientów)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba klientów, którzy nie wrócili do firmy po danej wycieczce", x = "Nazwa wycieczki", y = "Liczba klientów") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Klienci, którzy nie zdecydowali się ponownie wziąć udziału w wyjeździe organizowanym przez „Space-U", najczęściej wykupowali za pierwszym razem następujące wycieczki: `r df3_2$nazwa_wycieczki[1]`, `r df3_2$nazwa_wycieczki[2]`, `r df3_2$nazwa_wycieczki[3]`. Najczęściej wybieraną wśród nich wycieczką była wycieczka o nazwie `r df3_2_1$nazwa_wycieczki`, na którą wybrało się `r df3_2_1$liczba_klientów` klientów. Może to oznaczać, że zaproponowana wycieczka nie spotyka się z pozytywnym odbiorem wszystkich klientów, zatem należy wprowadzić zmiany w jej plan. W przypadku dalszego braku zainteresowania kolejnymi wyjazdami z firmą wśród klientów, którzy wybrali się na wycieczkę tego typu, należy zastanowić się nad wycofaniem wycieczki z oferty i zastąpieniem jej inną propozycją.

### Który z typów wycieczek cieszy się większą popularnością – wycieczki z jasną czy ciemną stroną mocy?

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 12

query4 <- "SELECT force_side AS strona_mocy, COUNT(*) AS liczba_klientów
FROM spaceflight INNER JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip
INNER JOIN payment ON spaceflight.id_spaceflight = payment.id_spaceflight
GROUP BY force_side ORDER BY COUNT(*) DESC"

df4 <- dbGetQuery(con, query4)

ggplot(df4, aes(x = df4$strona_mocy, y = df4$liczba_klientów)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba klientów w zależności od strony mocy", x = "Strona mocy", y = "Liczba klientów")
```

### Jak często podczas wyjazdów zdarzają się wypadki konkretnych typów i jaka część klientów jest ubezpieczona na wypadek ich wystąpienia?

```{r}

```

### Czy wycieczki, którym klienci wystawiają najwyższe oceny, są również najchętniej wybierane?

```{r}

```

### Którzy spośród naszych pracowników (pilot i przewodnik) najczęściej latali wspólnie na wycieczki?

```{r}
#| echo: false
#| warning: false
#| fig.width: 9
#| fig.height: 12

query7 <- "SELECT s.id_pilot AS id_pilota, s.id_guide AS id_przewodnika, CONCAT(e1.first_name, ' ', e1.last_name, ', ', e2.first_name, ' ', 
e2.last_name) AS imiona, COUNT(*) AS liczba_wyjazdów
FROM spaceflight AS s INNER JOIN employee AS e1 ON s.id_pilot = e1.id_employee
INNER JOIN employee AS e2 ON s.id_guide = e2.id_employee
GROUP BY s.id_pilot, s.id_guide
ORDER BY COUNT(*) DESC"

df7 <- dbGetQuery(con, query7)

ggplot(df7, aes(x = df7$imiona, y = df7$liczba_wyjazdów)) +
  geom_col(fill = "lightblue") +
  labs(title = "Liczba wspólnych wyjazdów wybranych członków załogi", x = "Załoga", y = "Liczba wyjazdów") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
#| echo: false
#zamykanie połączenia
dbDisconnect(con)
```
