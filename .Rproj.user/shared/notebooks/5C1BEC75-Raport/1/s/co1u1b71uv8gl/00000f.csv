"0","#| echo: false"
"0","#| warning: false"
"0","#| fig.width: 12"
"0","#| fig.height: 10"
"0","#| fig.align: ""center"""
"0",""
"0","query <- """
"0","SELECT "
"0","  spaceflight.id_spaceflight,"
"0","  spaceflight.id_trip,"
"0","  spaceflight.departure_date,"
"0","  spaceflight.return_date,"
"0","  spaceflight.organization_cost,"
"0","  trip_type.trip_name,"
"0","  trip_type.daily_cost_per_participant,"
"0","  trip_type.customer_price_total,"
"0","  payment.id_payment"
"0","FROM spaceflight"
"0","JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip"
"0","LEFT JOIN payment ON spaceflight.id_spaceflight = payment.id_spaceflight"
"0",""""
"0",""
"0","df <- dbGetQuery(con, query)"
"0",""
"0","# Przetwarzanie dat i czasu trwania"
"0","df <- df %>%"
"0","  mutate("
"0","    departure_date = as.Date(departure_date),"
"0","    return_date = as.Date(return_date),"
"0","    duration_days = as.numeric(return_date - departure_date)"
"0","  )"
"0",""
"0","# Liczba klientów na każdy lot"
"0","liczba_klientow_df <- df %>%"
"0","  group_by(id_spaceflight) %>%"
"0","  summarise(liczba_klientow = n(), .groups = ""drop"")"
"0",""
"0","# Scalenie z oryginalną ramką i usunięcie duplikatów płatności"
"0","df_unique <- df %>%"
"0","  distinct(id_spaceflight, .keep_all = TRUE) %>%"
"0","  left_join(liczba_klientow_df, by = ""id_spaceflight"")"
"0",""
"0","# Koszty i przychody dla każdego lotu"
"0","df_obliczone <- df_unique %>%"
"0","  mutate("
"0","    koszt_organizacji = organization_cost,"
"0","    koszt_utrzymania = duration_days * daily_cost_per_participant * liczba_klientow,"
"0","    koszt_calkowity = koszt_organizacji + koszt_utrzymania,"
"0","    przychod = liczba_klientow * customer_price_total"
"0","  )"
"0",""
"0","# Sumowanie po nazwach wycieczek"
"0","suma <- df_obliczone %>%"
"0","  group_by(trip_name) %>%"
"0","  summarise("
"0","    suma_koszt_organizacji = sum(koszt_organizacji),"
"0","    suma_koszt_utrzymania = sum(koszt_utrzymania),"
"0","    suma_koszt_lacznie = sum(koszt_calkowity),"
"0","    suma_przychod = sum(przychod),"
"0","    zysk = suma_przychod - suma_koszt_lacznie,"
"0","    .groups = ""drop"""
"0","  )"
"0",""
"0","# Long format"
"0","dane_long <- suma %>%"
"0","  select(trip_name, Koszty = suma_koszt_lacznie, Przychód = suma_przychod, Zysk = zysk) %>%"
"0","  pivot_longer(cols = -trip_name, names_to = ""typ"", values_to = ""wartosc"")"
"0",""
"0","# Wykres"
"0","ggplot(dane_long, aes(x = trip_name, y = wartosc, fill = typ)) +"
"0","  geom_col(position = position_dodge(width = 0.9)) +"
"0","  geom_text(aes(label = ifelse(wartosc >= 1e6,"
"0","                               paste0(round(wartosc / 1e6, 1), "" M""),"
"0","                               ifelse(wartosc >= 1e3,"
"0","                                      paste0(round(wartosc / 1e3, 1), "" k""),"
"0","                                      round(wartosc)))),"
"0","            position = position_dodge(width = 0.9), "
"0","            vjust = -0.5, size = 4) +"
"0","  scale_y_continuous("
"0","    labels = scales::label_number(big.mark = "" "", decimal.mark = "","")"
"0","  ) +"
"0","  scale_fill_manual(values = c(""Koszty"" = ""pink"", ""Przychód"" = ""lightblue"", ""Zysk"" = ""lightgreen"")) +"
"0","  labs("
"0","    title = ""Suma kosztów, przychodów i zysków z każdej wycieczki"","
"0","    x = ""Wycieczka"","
"0","    y = ""Kwota"","
"0","    fill = ""Rodzaj"""
"0","  ) +"
"0","  theme_minimal() +"
"0","  theme("
"0","    plot.title = element_text(size = 18, face = ""bold"", hjust = 0.5),"
"0","    axis.title.x = element_text(size = 14),"
"0","    axis.title.y = element_text(size = 14),"
"0","    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),"
"0","    axis.text.y = element_text(size = 12),"
"0","    legend.title = element_text(size = 13),"
"0","    legend.text = element_text(size = 12)"
"0","  )"
