"0","#| echo: false"
"0","#| warning: false"
"0","#| fig.width: 9"
"0","#| fig.height: 7"
"0","#| fig.align: ""center"""
"0",""
"0","query <- """
"0","SELECT "
"0","  spaceflight.id_spaceflight,"
"0","  spaceflight.id_trip,"
"0","  spaceflight.departure_date,"
"0","  spaceflight.return_date,"
"0","  spaceflight.organization_cost,"
"0","  trip_type.daily_cost_per_participant,"
"0","  trip_type.customer_price_total,"
"0","  payment.id_payment"
"0","FROM spaceflight"
"0","JOIN trip_type ON spaceflight.id_trip = trip_type.id_trip"
"0","LEFT JOIN payment ON spaceflight.id_spaceflight = payment.id_spaceflight"
"0",""""
"0","df <- dbGetQuery(con, query)"
"0",""
"0","# Dane o pracownikach"
"0","employee_df <- dbGetQuery(con, ""SELECT hire_date, leave_date, salary FROM employee"")"
"0",""
"0","# Czas trwania lotów"
"0","df <- df %>%"
"0","  mutate("
"0","    departure_date = as.Date(departure_date),"
"0","    return_date = as.Date(return_date),"
"0","    duration_days = as.numeric(return_date - departure_date)"
"0","  )"
"0",""
"0","# Liczba klientów na każdy lot"
"0","liczba_klientow_df <- df %>%"
"0","  group_by(id_spaceflight) %>%"
"0","  summarise(liczba_klientow = n(), .groups = ""drop"")"
"0",""
"0","# Połączenie i usunięcie duplikatów płatności"
"0","df_unique <- df %>%"
"0","  distinct(id_spaceflight, .keep_all = TRUE) %>%"
"0","  left_join(liczba_klientow_df, by = ""id_spaceflight"")"
"0",""
"0","# Koszty i przychody na lot"
"0","df_obliczone <- df_unique %>%"
"0","  mutate("
"0","    koszt_organizacji = organization_cost,"
"0","    koszt_utrzymania = duration_days * daily_cost_per_participant * liczba_klientow,"
"0","    przychod = liczba_klientow * customer_price_total"
"0","  )"
"0",""
"0","# SUMA kosztów i przychodów z lotów"
"0","suma_koszt_organizacji <- sum(df_obliczone$koszt_organizacji, na.rm = TRUE)"
"0","suma_koszt_utrzymania <- sum(df_obliczone$koszt_utrzymania, na.rm = TRUE)"
"0","suma_przychod <- sum(df_obliczone$przychod, na.rm = TRUE)"
"0",""
"0","# Koszt wypłat pracowników"
"0","dzisiaj <- as.Date(""2100-01-01"")"
"0",""
"0","employee_df <- employee_df %>%"
"0","  mutate("
"0","    hire_date = as.Date(hire_date),"
"0","    leave_date = as.character(leave_date),"
"0","    leave_date = ifelse(is.na(leave_date) | leave_date == ""None"","
"0","                        as.character(dzisiaj),"
"0","                        leave_date),"
"0","    leave_date = as.Date(leave_date),"
"0","    dni_pracy = as.numeric(leave_date - hire_date),"
"0","    miesiace_pracy = dni_pracy / 30,"
"0","    wyplata = miesiace_pracy * salary"
"0","  )"
"0",""
"0","suma_wyplaty <- sum(employee_df$wyplata, na.rm = TRUE)"
"0",""
"0","# Całkowite koszty i zysk"
"0","suma_koszt_calkowity <- suma_koszt_organizacji + suma_koszt_utrzymania + suma_wyplaty"
"0","zysk_firmy <- suma_przychod - suma_koszt_calkowity"
"0",""
"0","df_wykres <- data.frame("
"0","  Rodzaj = c(""Koszty"", ""Przychód"", ""Zysk""),"
"0","  Kwota = c(suma_koszt_calkowity, suma_przychod, zysk_firmy)"
"0",")"
"0",""
"0","ggplot(df_wykres, aes(x = Rodzaj, y = Kwota, fill = Rodzaj)) +"
"0","  geom_col(width = 0.6) +"
"0","  geom_text("
"0","    aes(label = format(Kwota, big.mark = "" "", scientific = FALSE)),"
"0","    vjust = -0.5,"
"0","    size = 5"
"0","  ) +"
"0","  scale_y_continuous("
"0","    labels = label_number(big.mark = "" "", decimal.mark = "","")"
"0","  ) +"
"0","  scale_fill_manual(values = c(""Koszty"" = ""pink"", ""Przychód"" = ""lightblue"", ""Zysk"" = ""lightgreen"")) +"
"0","  labs("
"0","    title = ""Podsumowanie finansowe firmy"","
"0","    x = """","
"0","    y = ""Kwota"""
"0","  ) +"
"0","  theme_minimal() +"
"0","  theme("
"0","    plot.title = element_text(size = 18, face = ""bold"", hjust = 0.5),"
"0","    axis.title.y = element_text(size = 14),"
"0","    axis.text.x = element_text(size = 13),"
"0","    axis.text.y = element_text(size = 12),"
"0","    legend.position = ""none"""
"0","  )"
